@page "/tickets"
@using EnterpriseTicketing.Domain.Entities
@inject HttpClient Http
@inject ILocalizationService Localization

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudText Typo="Typo.h3" Class="mb-4">@Localization.GetLocalizedString("Tickets.Title")</MudText>

    <MudGrid>
        <MudItem xs="12">
            <MudPaper Class="pa-4">
                <MudToolBar>
                    <MudButton Variant="Variant.Filled" 
                              Color="Color.Primary" 
                              StartIcon="@Icons.Material.Filled.Add"
                              OnClick="@(() => CreateNewTicket())">
                        تیکت جدید
                    </MudButton>
                    <MudSpacer />
                    <MudTextField T="string" 
                                ValueChanged="@(s => OnSearch(s))"
                                Placeholder="جستجو"
                                Adornment="Adornment.Start"
                                AdornmentIcon="@Icons.Material.Filled.Search"
                                IconSize="Size.Medium"
                                Class="mt-0" />
                </MudToolBar>

                <MudTable Items="@Tickets" Dense="true" Hover="true" @ref="table"
                         Loading="@_loading" LoadingProgressColor="Color.Info">
                    <HeaderContent>
                        <MudTh>شناسه</MudTh>
                        <MudTh>عنوان</MudTh>
                        <MudTh>اولویت</MudTh>
                        <MudTh>وضعیت</MudTh>
                        <MudTh>تاریخ ایجاد</MudTh>
                        <MudTh>عملیات</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="شناسه">@context.Id</MudTd>
                        <MudTd DataLabel="عنوان">@context.Title</MudTd>
                        <MudTd DataLabel="اولویت">
                            <MudChip Color="@GetPriorityColor(context.Priority)">
                                @context.Priority.ToString()
                            </MudChip>
                        </MudTd>
                        <MudTd DataLabel="وضعیت">
                            <MudChip Color="@GetStatusColor(context.Status)">
                                @context.Status.ToString()
                            </MudChip>
                        </MudTd>
                        <MudTd DataLabel="تاریخ">@context.CreatedAt.ToString("yyyy/MM/dd")</MudTd>
                        <MudTd>
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                         Color="Color.Primary"
                                         OnClick="@(() => EditTicket(context))" />
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                         Color="Color.Error"
                                         OnClick="@(() => DeleteTicket(context))" />
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private bool _loading = true;
    private MudTable<Ticket> table;
    private List<Ticket> Tickets = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadTickets();
    }

    private async Task LoadTickets()
    {
        _loading = true;
        try
        {
            var response = await Http.GetFromJsonAsync<List<Ticket>>("api/tickets");
            if (response != null)
                Tickets = response;
        }
        catch (Exception ex)
        {
            // TODO: Handle error
        }
        _loading = false;
    }

    private Color GetPriorityColor(TicketPriority priority) => priority switch
    {
        TicketPriority.Low => Color.Success,
        TicketPriority.Medium => Color.Info,
        TicketPriority.High => Color.Warning,
        TicketPriority.Critical => Color.Error,
        _ => Color.Default
    };

    private Color GetStatusColor(TicketStatus status) => status switch
    {
        TicketStatus.New => Color.Info,
        TicketStatus.InProgress => Color.Warning,
        TicketStatus.Resolved => Color.Success,
        TicketStatus.Closed => Color.Dark,
        _ => Color.Default
    };

    private void CreateNewTicket()
    {
        // TODO: Implement
    }

    private void EditTicket(Ticket ticket)
    {
        // TODO: Implement
    }

    private async Task DeleteTicket(Ticket ticket)
    {
        // TODO: Implement
    }

    private void OnSearch(string text)
    {
        // TODO: Implement
    }
}