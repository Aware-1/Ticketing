@inherits LayoutComponentBase
@inject NavigationManager NavigationManager
@inject ILocalizationService Localization
@inject AuthenticationStateProvider AuthStateProvider

<MudThemeProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar Elevation="1">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@((e) => DrawerToggle())" />
        <MudText Typo="Typo.h6">سامانه تیکتینگ</MudText>
        <MudSpacer />
        <MudMenu Icon="@Icons.Material.Filled.Translate" Color="Color.Inherit" Edge="Edge.End" AnchorOrigin="Origin.BottomRight">
            <MudMenuItem OnClick="@(() => SwitchLanguage("fa"))">فارسی</MudMenuItem>
            <MudMenuItem OnClick="@(() => SwitchLanguage("en"))">English</MudMenuItem>
        </MudMenu>
        <AuthorizeView>
            <Authorized>
                <MudMenu Icon="@Icons.Material.Filled.Person" Color="Color.Inherit" Edge="Edge.End" AnchorOrigin="Origin.BottomRight">
                    <MudMenuItem Icon="@Icons.Material.Filled.Person" OnClick="@(() => NavigationManager.NavigateTo("/profile"))">
                        @Localization.GetLocalizedString("Menu.Profile")
                    </MudMenuItem>
                    <MudMenuItem Icon="@Icons.Material.Filled.Settings" OnClick="@(() => NavigationManager.NavigateTo("/settings"))">
                        @Localization.GetLocalizedString("Menu.Settings")
                    </MudMenuItem>
                    <MudDivider />
                    <MudMenuItem Icon="@Icons.Material.Filled.Logout" OnClick="Logout">
                        @Localization.GetLocalizedString("Menu.Logout")
                    </MudMenuItem>
                </MudMenu>
            </Authorized>
        </AuthorizeView>
    </MudAppBar>
    
    <MudDrawer @bind-Open="@_drawerOpen" ClipMode="DrawerClipMode.Always" Elevation="2">
        <AuthorizeView>
            <Authorized>
                <MudNavMenu>
                    <MudNavLink Href="/" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Dashboard">
                        @Localization.GetLocalizedString("Menu.Dashboard")
                    </MudNavLink>
                    <MudNavLink Href="/tickets" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.ConfirmationNumber">
                        @Localization.GetLocalizedString("Menu.Tickets")
                    </MudNavLink>
                    <AuthorizeView Roles="Admin,Agent">
                        <Authorized>
                            <MudNavGroup Title="@Localization.GetLocalizedString("Menu.Management")" Icon="@Icons.Material.Filled.ManageAccounts" Expanded="true">
                                <MudNavLink Href="/users" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.People">
                                    @Localization.GetLocalizedString("Menu.Users")
                                </MudNavLink>
                                <MudNavLink Href="/sla" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Speed">
                                    @Localization.GetLocalizedString("Menu.SLA")
                                </MudNavLink>
                            </MudNavGroup>
                            <MudNavLink Href="/reports" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Assessment">
                                @Localization.GetLocalizedString("Menu.Reports")
                            </MudNavLink>
                        </Authorized>
                    </AuthorizeView>
                </MudNavMenu>
            </Authorized>
            <NotAuthorized>
                <MudNavMenu>
                    <MudNavLink Href="/auth/login" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Login">
                        @Localization.GetLocalizedString("Auth.Login")
                    </MudNavLink>
                    <MudNavLink Href="/auth/register" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.PersonAdd">
                        @Localization.GetLocalizedString("Auth.Register")
                    </MudNavLink>
                </MudNavMenu>
            </NotAuthorized>
        </AuthorizeView>
    </MudDrawer>
    
    <MudMainContent Class="pt-16 px-4">
        <MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout>

@code {
    private bool _drawerOpen = true;

    private void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }

    private async Task Logout()
    {
        ((CustomAuthStateProvider)AuthStateProvider).NotifyUserLogout();
        NavigationManager.NavigateTo("/auth/login");
    }

    private void SwitchLanguage(string culture)
    {
        // TODO: Implement language switching
    }
}
