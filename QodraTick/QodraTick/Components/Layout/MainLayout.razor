@using Microsoft.AspNetCore.Components.Authorization
@using Service.IService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IUserService UserService
@inherits LayoutComponentBase

<div class="page">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="bi bi-ticket-perforated me-2"></i>
                قدرا تیک
            </a>
            
            <!-- Mobile menu toggle -->
            <button class="navbar-toggler d-lg-none" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <div class="navbar-nav me-auto">
                    <AuthorizeView>
                        <Authorized>
                            <span class="navbar-text me-3">
                                <i class="bi bi-person-circle me-1"></i>
                                سلام @GetDisplayName(context.User)
                            </span>
                            <span class="badge bg-light text-dark me-2">@GetUserRole(context.User)</span>
                            <a href="/logout" class="btn btn-outline-light btn-sm">
                                <i class="bi bi-box-arrow-right me-1"></i>
                                خروج
                            </a>
                        </Authorized>
                        <NotAuthorized>
                            <a href="/login" class="btn btn-outline-light">
                                <i class="bi bi-box-arrow-in-right me-1"></i>
                                ورود
                            </a>
                        </NotAuthorized>
                    </AuthorizeView>
                </div>
            </div>
        </div>
    </nav>

    <AuthorizeView>
        <Authorized>
            <div class="container-fluid">
                <div class="row">
                    <!-- Sidebar -->
                    <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                        <div class="position-sticky pt-3">
                            @{
                                var userRole = context.User.FindFirst(ClaimTypes.Role)?.Value;
                            }
                            @switch (userRole)
                            {
                                case "User":
                                    <UserNavigation />
                                    break;
                                case "Support":
                                    <SupportNavigation />
                                    break;
                                case "Admin":
                                    <AdminNavigation />
                                    break;
                                default:
                                    <div class="alert alert-warning">
                                        <i class="bi bi-exclamation-triangle me-2"></i>
                                        نقش کاربری تشخیص داده نشد
                                    </div>
                                    break;
                            }
                        </div>
                    </nav>

                    <!-- Main content -->
                    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                        @Body
                    </main>
                </div>
            </div>
        </Authorized>
        <NotAuthorized>
            <!-- Full-width content for unauthorized users (login page) -->
            @Body
        </NotAuthorized>
    </AuthorizeView>
</div>

<!-- Error UI -->
<div id="blazor-error-ui">
    <div class="alert alert-danger" role="alert">
        <i class="bi bi-exclamation-triangle me-2"></i>
        خطایی رخ داده است. این برنامه ممکن است تا زمان بارگذاری مجدد پاسخ ندهد.
        <div class="mt-2">
            <a href="" class="reload btn btn-sm btn-outline-danger me-2">
                <i class="bi bi-arrow-clockwise me-1"></i>
                بارگذاری مجدد
            </a>
            <a class="dismiss btn btn-sm btn-outline-secondary">
                <i class="bi bi-x me-1"></i>
                بستن
            </a>
        </div>
    </div>
</div>

<!-- Notification Component -->
<NotificationComponent />

@code {
    private string GetDisplayName(ClaimsPrincipal user)
    {
        return user.FindFirst("DisplayName")?.Value ?? 
               user.Identity?.Name ?? 
               "کاربر";
    }

    private string GetUserRole(ClaimsPrincipal user)
    {
        return user.FindFirst(ClaimTypes.Role)?.Value switch
        {
            "User" => "کاربر",
            "Support" => "پشتیبان",
            "Admin" => "مدیر",
            _ => "نامشخص"
        };
    }
}